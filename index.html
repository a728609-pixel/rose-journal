<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>迪士尼感恩收藏館</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        input, textarea { font-size: 16px !important; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(5%); } }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }
    </style>
</head>
<body class="bg-[#FFFBF0]">
    <div id="root"></div>
    <script>
        window.onerror = function(message) {
            const root = document.getElementById('root');
            if (root && root.innerHTML === "") root.innerHTML = `<div style="padding:20px;color:#78350F;text-align:center;margin-top:50px;"><h3>App 發生錯誤</h3><p>${message}</p></div>`;
        };
    </script>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // --- 核心設定 ---
        // 這裡故意留空，因為我們要讓使用者在介面上輸入，避免被 Google 封鎖
        const DEFAULT_API_KEY = ""; 

        const CHAR_DATA = [
            { id: 'mickey', name: '經典米奇', keywords: '快樂,開始,樂觀,領袖,經典', rarity: 'UR', base: '#000', face: '#fce7f3', body: '#ef4444', ears: 'round_black', acc: 'buttons' },
            { id: 'minnie', name: '甜心米妮', keywords: '愛情,甜蜜,打扮,約會,蝴蝶結', rarity: 'SSR', base: '#000', face: '#fce7f3', body: '#ec4899', ears: 'round_black', acc: 'bow_red' },
            { id: 'donald', name: '唐老鴨', keywords: '生氣,倒霉,堅持,努力,鴨子', rarity: 'SR', base: '#fff', face: '#fff', body: '#3b82f6', ears: 'none', acc: 'hat_sailor' },
            { id: 'daisy', name: '黛西', keywords: '自信,時尚,愛美,脾氣,紫色', rarity: 'SR', base: '#fff', face: '#fff', body: '#a855f7', ears: 'none', acc: 'bow_pink' },
            { id: 'goofy', name: '高飛', keywords: '傻氣,單純,搞笑,樂天,跌倒', rarity: 'R', base: '#000', face: '#fce7f3', body: '#f97316', ears: 'long_black', acc: 'hat_green' },
            { id: 'pluto', name: '布鲁托', keywords: '忠誠,寵物,陪伴,直覺,狗狗', rarity: 'R', base: '#fbbf24', face: '#fbbf24', body: '#fbbf24', ears: 'long_black', acc: 'collar_green' },
            { id: 'chip', name: '奇奇', keywords: '聰明,計畫,兄弟,忙碌,松鼠', rarity: 'R', base: '#78350f', face: '#fef3c7', body: '#78350f', ears: 'chip_ears', acc: 'nose_black' },
            { id: 'dale', name: '蒂蒂', keywords: '傻呼呼,玩樂,放鬆,惡作劇,松鼠', rarity: 'R', base: '#92400e', face: '#fef3c7', body: '#92400e', ears: 'chip_ears', acc: 'nose_red' },
            { id: 'pooh', name: '維尼', keywords: '美食,蜂蜜,慵懶,友誼,黃色', rarity: 'SSR', base: '#fbbf24', face: '#fbbf24', body: '#ef4444', ears: 'round_yellow', acc: 'none' },
            { id: 'piglet', name: '小豬', keywords: '膽小,勇敢,微小,溫柔,粉紅', rarity: 'R', base: '#fbcfe8', face: '#fbcfe8', body: '#db2777', ears: 'pointy_pink', acc: 'stripes' },
            { id: 'tigger', name: '跳跳虎', keywords: '活力,跳躍,自信,獨一無二,橘色', rarity: 'SR', base: '#f97316', face: '#fef3c7', body: '#f97316', ears: 'round_orange', acc: 'stripes_black' },
            { id: 'eeyore', name: '屹耳', keywords: '憂鬱,接受,慢活,低潮,灰色', rarity: 'R', base: '#64748b', face: '#cbd5e1', body: '#64748b', ears: 'long_droopy', acc: 'bow_tail' },
            { id: 'stitch', name: '史迪奇', keywords: '家人,破壞,搞怪,外星人,藍色', rarity: 'UR', base: '#3b82f6', face: '#60a5fa', body: '#3b82f6', ears: 'stitch_ears', acc: 'teeth' },
            { id: 'angel', name: '安琪', keywords: '魅力,歌聲,粉紅,戀愛,女朋友', rarity: 'SR', base: '#ec4899', face: '#f9a8d4', body: '#ec4899', ears: 'stitch_ears_pink', acc: 'antenna' },
            { id: 'woody', name: '胡迪', keywords: '責任,懷舊,領導,夥伴,牛仔', rarity: 'SSR', base: '#fef3c7', face: '#fef3c7', body: '#fbbf24', ears: 'none', acc: 'hat_cowboy' },
            { id: 'buzz', name: '巴斯光年', keywords: '無限,超越,飛翔,科技,太空', rarity: 'SSR', base: '#fff', face: '#fce7f3', body: '#fff', ears: 'none', acc: 'helmet' },
            { id: 'alien', name: '三眼怪', keywords: '團體,感激,驚喜,被選中,爪子', rarity: 'SR', base: '#84cc16', face: '#84cc16', body: '#3b82f6', ears: 'pointy_green', acc: 'three_eyes' },
            { id: 'lotso', name: '熊抱哥', keywords: '草莓,擁抱,過去,複雜,粉紅熊', rarity: 'SSR', base: '#9d174d', face: '#fce7f3', body: '#be185d', ears: 'round_dark_pink', acc: 'cane' },
            { id: 'hamm', name: '火腿豬', keywords: '存錢,現實,聰明,吐槽,小豬撲滿', rarity: 'R', base: '#fca5a5', face: '#fca5a5', body: '#fca5a5', ears: 'pointy_pink', acc: 'coin_slot' },
            { id: 'rex', name: '抱抱龍', keywords: '焦慮,遊戲,恐龍,善良,綠色', rarity: 'R', base: '#22c55e', face: '#22c55e', body: '#22c55e', ears: 'none', acc: 'teeth' },
            { id: 'sulley', name: '毛怪', keywords: '強壯,溫柔,保護,毛茸茸,藍色', rarity: 'SR', base: '#3b82f6', face: '#3b82f6', body: '#3b82f6', ears: 'horns', acc: 'spots_purple' },
            { id: 'mike', name: '大眼仔', keywords: '樂觀,學習,觀察,目標,眼睛', rarity: 'SR', base: '#84cc16', face: '#84cc16', body: '#84cc16', ears: 'horns', acc: 'one_eye' },
            { id: 'boo', name: '阿布', keywords: '純真,不怕,捉迷藏,可愛,小女孩', rarity: 'R', base: '#fce7f3', face: '#fce7f3', body: '#ec4899', ears: 'pigtails', acc: 'monster_costume' },
            { id: 'elsa', name: '艾莎', keywords: '釋放,冰雪,獨立,女王,藍色', rarity: 'UR', base: '#e0f2fe', face: '#fce7f3', body: '#38bdf8', ears: 'braid_white', acc: 'crown_ice' },
            { id: 'anna', name: '安娜', keywords: '熱情,活潑,姊妹,冒險,紫色', rarity: 'SSR', base: '#fce7f3', face: '#fce7f3', body: '#0ea5e9', ears: 'braids_brown', acc: 'cape_purple' },
            { id: 'ariel', name: '愛麗兒', keywords: '好奇,歌聲,海洋,新世界,人魚', rarity: 'SSR', base: '#fce7f3', face: '#fce7f3', body: '#22c55e', ears: 'hair_red_long', acc: 'flower' },
            { id: 'belle', name: '貝兒', keywords: '閱讀,玫瑰,內在美,夢想,黃色', rarity: 'SSR', base: '#fce7f3', face: '#fce7f3', body: '#fbbf24', ears: 'hair_brown_bun', acc: 'rose' },
            { id: 'jasmine', name: '茉莉', keywords: '自由,老虎,星空,飛毯,異國', rarity: 'SSR', base: '#fce7f3', face: '#fce7f3', body: '#22d3ee', ears: 'hair_black_ponytail', acc: 'headband' },
            { id: 'rapunzel', name: '樂佩', keywords: '畫畫,光芒,長髮,探索,紫色', rarity: 'SSR', base: '#fce7f3', face: '#fce7f3', body: '#d8b4fe', ears: 'hair_long_gold', acc: 'flowers_hair' },
            { id: 'cinderella', name: '仙度瑞拉', keywords: '時間,南瓜,玻璃鞋,變身,藍色', rarity: 'SR', base: '#fce7f3', face: '#fce7f3', body: '#60a5fa', ears: 'hair_blonde_bun', acc: 'headband_blue' },
            { id: 'snowwhite', name: '白雪公主', keywords: '蘋果,動物,許願,善良,黑髮', rarity: 'SR', base: '#fce7f3', face: '#fce7f3', body: '#fbbf24', ears: 'hair_black_bob', acc: 'bow_red_head' },
            { id: 'baymax', name: '杯麵', keywords: '健康,療癒,照顧,擁抱,白色', rarity: 'SSR', base: '#fff', face: '#fff', body: '#fff', ears: 'none', acc: 'baymax_eyes' },
            { id: 'simba', name: '辛巴', keywords: '成長,責任,王者,草原,獅子', rarity: 'SSR', base: '#fbbf24', face: '#fbbf24', body: '#fbbf24', ears: 'round_lion', acc: 'mane_red' },
            { id: 'nemo', name: '尼莫', keywords: '大海,幸運,冒險,游泳,小丑魚', rarity: 'R', base: '#f97316', face: '#f97316', body: '#f97316', ears: 'nemo_fins', acc: 'nemo_stripes' },
            { id: 'dory', name: '多莉', keywords: '健忘,快樂,前進,鯨魚語', rarity: 'R', base: '#3b82f6', face: '#3b82f6', body: '#3b82f6', ears: 'fin_blue', acc: 'yellow_tail' },
            { id: 'olaf', name: '雪寶', keywords: '夏天,擁抱,雪人,融化,快樂', rarity: 'SR', base: '#fff', face: '#fff', body: '#fff', ears: 'twig_hair', acc: 'carrot_nose' },
            { id: 'genie', name: '精靈', keywords: '願望,魔法,自由,搞笑,藍色', rarity: 'SSR', base: '#3b82f6', face: '#3b82f6', body: '#3b82f6', ears: 'pointy_blue', acc: 'top_knot' },
            { id: 'mulan', name: '木蘭', keywords: '榮耀,戰鬥,偽裝,倒影,女戰士', rarity: 'SR', base: '#fce7f3', face: '#fce7f3', body: '#16a34a', ears: 'hair_black_bun', acc: 'sword' },
            { id: 'cheshire', name: '妙妙貓', keywords: '微笑,隱形,神秘,粉紅條紋,貓', rarity: 'SR', base: '#ec4899', face: '#ec4899', body: '#ec4899', ears: 'pointy_pink', acc: 'grin' },
        ];

        const SvgIcon = ({ path, size=24, className="", fill="none", stroke="currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke={stroke} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        const IconPaths = {
            Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
            Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />,
            Star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />,
            X: <path d="M18 6 6 18M6 6l12 12" />,
            Gift: <g><rect x="3" y="8" width="18" height="4" rx="1" /><path d="M12 8v13" /><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7" /><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.9 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5" /></g>,
            LayoutGrid: <g><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></g>,
            Plus: <path d="M5 12h14M12 5v14" />,
            Calendar: <g><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></g>,
            Search: <g><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></g>,
            Download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></g>,
            Sparkles: <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />,
            Trophy: <g><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" /></g>
        };

        const UniversalToy = ({ config, className }) => {
            if (!config) return null;
            const { base, face, body, ears, acc } = config;
            return (
                <svg viewBox="0 0 100 120" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
                <ellipse cx="50" cy="105" rx="35" ry="12" fill="#e5e7eb" stroke="rgba(0,0,0,0.1)" strokeWidth="2" />
                <path d="M15 105 L15 110 Q50 125 85 110 L85 105" fill="rgba(0,0,0,0.1)" />
                {ears === 'round_black' && <g><circle cx="25" cy="35" r="18" fill="#111" /><circle cx="75" cy="35" r="18" fill="#111" /></g>}
                {ears === 'round_yellow' && <g><circle cx="30" cy="35" r="10" fill={base} /><circle cx="70" cy="35" r="10" fill={base} /></g>}
                {ears === 'long_black' && <g><ellipse cx="30" cy="50" rx="8" ry="25" fill="#111" transform="rotate(-20 30 50)" /><ellipse cx="70" cy="50" rx="8" ry="25" fill="#111" transform="rotate(20 70 50)" /></g>}
                {ears === 'stitch_ears' && <g><path d="M10 30 Q5 70 30 60" fill={base} stroke="#1e3a8a" strokeWidth="2" /><path d="M90 30 Q95 70 70 60" fill={base} stroke="#1e3a8a" strokeWidth="2" /></g>}
                {ears === 'stitch_ears_pink' && <g><path d="M10 30 Q5 70 30 60" fill={base} stroke="#be185d" strokeWidth="2" /><path d="M90 30 Q95 70 70 60" fill={base} stroke="#be185d" strokeWidth="2" /></g>}
                {ears === 'pointy_pink' && <g><path d="M35 25 L40 40 L30 40 Z" fill={body} /><path d="M65 25 L60 40 L70 40 Z" fill={body} /></g>}
                {ears === 'pointy_green' && <g><path d="M35 25 L40 40 L30 40 Z" fill={base} /><path d="M65 25 L60 40 L70 40 Z" fill={base} /><line x1="50" y1="20" x2="50" y2="35" stroke={base} strokeWidth="3"/><circle cx="50" cy="20" r="4" fill={base}/></g>}
                {ears === 'hair_long_gold' && <path d="M30 40 Q10 80 20 100 L80 100 Q90 80 70 40" fill="#fcd34d" />}
                {ears === 'hair_red_long' && <path d="M25 40 Q5 80 20 100 L80 100 Q95 80 75 40" fill="#dc2626" />}
                {ears === 'chip_ears' && <g><circle cx="30" cy="35" r="8" fill="#78350F" /><circle cx="70" cy="35" r="8" fill="#78350F" /></g>}
                {ears === 'horns' && <g><path d="M30 35 L25 25" stroke="#C7D2FE" strokeWidth="4" strokeLinecap="round" /><path d="M70 35 L75 25" stroke="#C7D2FE" strokeWidth="4" strokeLinecap="round" /></g>}
                {ears === 'fin_small' && <g><path d="M10 60 L30 50 L30 70 Z" fill={body}/></g>}
                {ears === 'fin_blue' && <g><path d="M10 50 L30 40 L30 70 Z" fill={body}/></g>}
                {ears === 'twig_hair' && <g><path d="M50 20 L50 35 M45 25 L50 35 M55 25 L50 35" stroke="#8b4513" strokeWidth="2"/></g>}
                {ears === 'nemo_fins' && <g><path d="M45 40 Q50 15 55 40" fill={base} /><path d="M78 60 Q95 50 78 80" fill={base} /><path d="M22 60 Q5 55 22 70" fill={base} /></g>}
                <path d="M30 80 Q50 105 70 80 L70 100 Q50 115 30 100 Z" fill={body} />
                <circle cx="50" cy="60" r="28" fill={face} />
                {(config.id === 'mickey' || config.id === 'minnie') && <path d="M50 85 Q25 85 30 60 Q30 45 40 45 Q50 60 60 45 Q70 45 70 60 Q75 85 50 85" fill={face} stroke="none" />}
                {config.id === 'sulley' && <rect x="25" y="35" width="50" height="50" rx="15" fill={base} />}
                {acc === 'buttons' && <g><ellipse cx="42" cy="92" rx="3" ry="5" fill="#FFF" /><ellipse cx="58" cy="92" rx="3" ry="5" fill="#FFF" /></g>}
                {acc === 'bow_red' && <g><path d="M30 25 Q50 40 70 25 L65 45 Q50 35 35 45 Z" fill="#ef4444" /><circle cx="50" cy="35" r="5" fill="#ef4444" /></g>}
                {acc === 'bow_pink' && <g><path d="M30 25 Q50 40 70 25 L65 45 Q50 35 35 45 Z" fill="#ec4899" /><circle cx="50" cy="35" r="5" fill="#ec4899" /></g>}
                {acc === 'bow_red_head' && <g><path d="M30 25 Q50 40 70 25 L65 45 Q50 35 35 45 Z" fill="#ef4444" /><circle cx="50" cy="35" r="5" fill="#ef4444" /></g>}
                {acc === 'hat_sailor' && <g><path d="M30 30 L70 30 L65 20 L35 20 Z" fill="#3b82f6" /><ellipse cx="50" cy="65" rx="12" ry="6" fill="#f59e0b" /></g>}
                {acc === 'three_eyes' && <g><circle cx="35" cy="55" r="5" fill="white"/><circle cx="35" cy="55" r="2" fill="black"/><circle cx="50" cy="50" r="5" fill="white"/><circle cx="50" cy="50" r="2" fill="black"/><circle cx="65" cy="55" r="5" fill="white"/><circle cx="65" cy="55" r="2" fill="black"/></g>}
                {acc === 'one_eye' && <g><circle cx="50" cy="55" r="12" fill="white" stroke="#65a30d" strokeWidth="1"/><circle cx="50" cy="55" r="5" fill="#3b82f6"/><circle cx="50" cy="55" r="2" fill="black"/></g>}
                {acc === 'baymax_eyes' && <g><line x1="42" y1="55" x2="58" y2="55" stroke="#111" strokeWidth="1.5" /><circle cx="42" cy="55" r="1.5" fill="#111" /><circle cx="58" cy="55" r="1.5" fill="#111" /></g>}
                {acc === 'crown_ice' && <path d="M35 35 L42 20 L50 30 L58 20 L65 35" fill="none" stroke="#38bdf8" strokeWidth="2" />}
                {acc === 'teeth' && <path d="M40 70 Q50 75 60 70" fill="none" stroke="#1e3a8a" strokeWidth="2" />}
                {acc === 'carrot_nose' && <polygon points="50,60 50,65 70,68" fill="#f97316" />}
                {acc === 'nemo_stripes' && <g><path d="M42 35 Q50 32 58 35 V85 Q50 88 42 85 Z" fill="white" opacity="0.9" /><path d="M30 88 Q50 98 70 88 L70 95 Q50 105 30 95 Z" fill="white" /></g>}
                {acc === 'yellow_tail' && <path d="M45 85 L55 85 L50 100 Z" fill="#FACC15" />}
                {!['three_eyes', 'one_eye', 'baymax_eyes'].includes(acc) && <g><circle cx="40" cy="55" r="3" fill="#111" /><circle cx="60" cy="55" r="3" fill="#111" /></g>}
                </svg>
            );
        };

        const ApiKeyModal = ({ onSave }) => {
            const [key, setKey] = useState('');
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
                    <div className="bg-white w-full max-w-md rounded-[24px] p-6 relative z-10 shadow-2xl">
                        <h2 className="text-xl font-bold text-[#78350F] mb-2">歡迎來到迪士尼感恩收藏館 ✨</h2>
                        <p className="text-sm text-[#92400E] mb-4">為了啟動魔法 AI，請輸入您的 Google API Key。它只會儲存在您的手機裡。</p>
                        <input 
                            type="text" 
                            value={key} 
                            onChange={(e) => setKey(e.target.value)}
                            placeholder="貼上您的 API Key (AIza...)"
                            className="w-full p-3 border-2 border-[#FCD34D] rounded-xl mb-4 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-[#F59E0B]"
                        />
                        <button 
                            onClick={() => { if(key.trim()) onSave(key.trim()); }}
                            className="w-full bg-[#F59E0B] text-white py-3 rounded-xl font-bold shadow-md active:scale-95 transition-transform"
                        >
                            開啟魔法大門
                        </button>
                        <p className="text-xs text-gray-400 mt-4 text-center">如果您沒有 Key，請前往 Google AI Studio 申請。</p>
                    </div>
                </div>
            );
        };

        const WriteModal = ({ onClose, onSubmit, onSuccess }) => {
            const [points, setPoints] = useState(['', '', '', '', '']);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const filledCount = points.filter(p => p.trim()).length;

            const handleSubmit = async () => {
                if (filledCount === 0) return;
                setIsSubmitting(true);
                try {
                    const rawPoints = points.filter(p => p.trim());
                    const result = await onSubmit({ rawPoints });
                    setPoints(['', '', '', '', '']); 
                    if(result) { onClose(); onSuccess(result); }
                } catch(e) {
                    console.error(e);
                    const randomChar = CHAR_DATA[Math.floor(Math.random() * CHAR_DATA.length)].id;
                    onClose();
                    onSuccess({ summary: `(連線不穩定) 雖然訊號微弱，但我們收到了您的心意！`, characterId: randomChar });
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-[#78350F]/40 backdrop-blur-[2px] pointer-events-auto" onClick={!isSubmitting ? onClose : undefined}></div>
                    <div className="bg-[#FFFBF0] w-full max-w-lg sm:rounded-[40px] rounded-t-[40px] p-6 pointer-events-auto relative h-[85vh] flex flex-col shadow-2xl">
                        {isSubmitting && (
                            <div className="absolute inset-0 z-20 bg-white/95 rounded-[inherit] flex flex-col items-center justify-center p-8 text-center">
                                <div className="w-20 h-20 bg-[#FEF3C7] rounded-full flex items-center justify-center mb-6 animate-bounce-slow">
                                    <SvgIcon path={IconPaths.Star} size={40} className="text-[#F59E0B] fill-[#F59E0B]" />
                                </div>
                                <h3 className="text-xl font-black text-[#78350F] mb-2">正在尋找你的守護夥伴...</h3>
                            </div>
                        )}
                        <button onClick={onClose} disabled={isSubmitting} className="absolute top-6 right-6 p-2 bg-[#F3F4F6] rounded-full z-10"><SvgIcon path={IconPaths.X} size={20} className="text-[#9CA3AF]" /></button>
                        <div className="mb-6 mt-2 text-center"><h2 className="text-2xl font-black text-[#78350F]">今日的快樂碎片</h2></div>
                        <div className="flex-1 overflow-y-auto space-y-3 pb-4">
                            {points.map((p, i) => (
                                <div key={i} className="relative">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-8 bg-[#FDE68A] rounded-full flex items-center justify-center text-[#92400E] font-black text-sm border-2 border-[#FCD34D]">{i + 1}</div>
                                    <input value={p} onChange={e => {const n=[...points]; n[i]=e.target.value; setPoints(n)}} disabled={isSubmitting} className="w-full pl-16 pr-4 py-4 bg-white rounded-2xl border-2 border-[#F3F4F6] focus:border-[#FCD34D] text-[#78350F] font-bold" placeholder="今天發生了什麼好事？" />
                                </div>
                            ))}
                        </div>
                        <button onClick={handleSubmit} disabled={filledCount===0 || isSubmitting} className="w-full bg-[#F59E0B] text-white py-4 rounded-2xl font-black text-lg shadow-[0_4px_0_#B45309] mt-4 flex items-center justify-center gap-2 mb-8 sm:mb-0"><SvgIcon path={IconPaths.Gift} size={20} /> {isSubmitting ? '魔法詠唱中...' : '完成日記'}</button>
                    </div>
                </div>
            );
        };

        const DailyCardModal = ({ item, summary, onClose }) => {
            if (!item) return null;
            const itemData = CHAR_DATA.find(i => i.id === item) || CHAR_DATA[0];
            const todayStr = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
            const rarityColors = { 'UR': 'bg-gradient-to-tr from-purple-500 to-indigo-500', 'SSR': 'bg-gradient-to-tr from-yellow-400 to-orange-500', 'SR': 'bg-gradient-to-tr from-blue-400 to-cyan-500', 'R': 'bg-gradient-to-tr from-green-400 to-emerald-500' };
            const rarityBg = rarityColors[itemData.rarity] || rarityColors['R'];

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose} />
                    <div className="bg-[#FFFBF0] w-full max-w-sm rounded-[32px] overflow-hidden relative z-10 animate-in zoom-in-95 duration-500 shadow-[0_20px_50px_rgba(0,0,0,0.3)] border-4 border-white ring-4 ring-[#FDE68A]">
                        <div className={`h-72 relative flex items-center justify-center p-6 shrink-0 bg-[#FFF7ED] overflow-hidden`}>
                             <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#F59E0B 2px, transparent 2px)', backgroundSize: '20px 20px'}}></div>
                             <div className="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full bg-gradient-to-b from-white/60 to-transparent pointer-events-none"></div>
                             <div className="w-56 h-56 drop-shadow-2xl animate-in zoom-in duration-700 delay-150 relative z-10 transform hover:scale-105 transition-transform duration-300"><UniversalToy config={itemData} /></div>
                             <div className="absolute top-4 right-4"><span className={`px-3 py-1 rounded-full text-xs font-black italic shadow-lg text-white ${rarityBg} border-2 border-white`}>{itemData.rarity}</span></div>
                        </div>
                        <div className="p-6 flex-1 overflow-y-auto bg-white relative rounded-t-[32px] -mt-6 shadow-[0_-10px_20px_rgba(0,0,0,0.05)]">
                             <div className="text-center mb-6"><div className="inline-block px-3 py-1 bg-[#FEF3C7] text-[#D97706] text-[10px] font-bold rounded-full mb-2">NEW FRIEND!</div><h2 className="text-2xl font-black text-[#78350F] mb-1">{itemData.name}</h2><p className="text-xs text-[#92400E] font-medium">{todayStr}</p></div>
                             <div className="bg-[#FFFBEB] p-5 rounded-2xl border border-[#FDE68A]"><div className="flex items-start gap-2"><SvgIcon path={IconPaths.Sparkles} size={16} className="text-[#F59E0B] shrink-0 mt-1" /><p className="text-[#92400E] leading-relaxed font-bold text-justify text-sm">{summary}</p></div></div>
                        </div>
                        <div className="p-4 bg-white border-t border-[#F3F4F6] grid grid-cols-2 gap-3 shrink-0">
                             <button onClick={onClose} className="flex items-center justify-center gap-2 py-3.5 rounded-2xl bg-[#F3F4F6] text-[#6B7280] font-bold text-sm hover:bg-[#E5E7EB] transition-colors"><SvgIcon path={IconPaths.Download} size={18} /> 保存</button>
                             <button onClick={onClose} className="flex items-center justify-center gap-2 py-3.5 rounded-2xl bg-[#F59E0B] text-white font-bold text-sm hover:bg-[#D97706] transition-colors shadow-[0_4px_0_#B45309] active:shadow-none active:translate-y-1"><SvgIcon path={IconPaths.Gift} size={18} /> 收入收藏櫃</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // 每日語錄 (Daily Quote with Random Logic)
        const DailyQuote = () => {
            const QUOTES = ["「只要你相信，夢想就會成真。」", "「逆境中綻放的花朵，是最珍貴美麗的。」", "「記住你是誰。」", "「Hakuna Matata，意思是別擔心。」", "「有些人值得你為他融化。」", "「Ohana 就是家人，沒人會被遺忘。」", "「冒險就在前方！」", "「笑聲是永恆的，夢想是永存的。」", "「如果你能夢想，你就能做到。」", "「去生活，去夢想，去探索。」"];
            const todayStr = new Date().toDateString();
            let hash = 0;
            for (let i = 0; i < todayStr.length; i++) hash = todayStr.charCodeAt(i) + ((hash << 5) - hash);
            const quote = QUOTES[Math.abs(hash) % QUOTES.length];

            return (
                <div className="mx-4 mt-4 p-5 bg-[#FFFBEB] rounded-[24px] border-2 border-[#FCD34D] shadow-sm flex items-start gap-3">
                    <div className="bg-[#F59E0B] p-2 rounded-xl text-white"><SvgIcon path={IconPaths.Star} size={20} fill="currentColor" /></div>
                    <div><p className="text-xs font-bold text-[#D97706] mb-1">今日魔法小語</p><h3 className="text-[15px] font-bold text-[#78350F]">{quote}</h3></div>
                </div>
            );
        };

        const App = () => {
            const [entries, setEntries] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [showRewardModal, setShowRewardModal] = useState(false);
            const [newRewardItem, setNewRewardItem] = useState(null);
            const [newRewardSummary, setNewRewardSummary] = useState('');
            const [activeTab, setActiveTab] = useState('collection');
            const [userApiKey, setUserApiKey] = useState(localStorage.getItem('gemini_api_key') || "");
            const [showKeyModal, setShowKeyModal] = useState(!localStorage.getItem('gemini_api_key'));

            // 初始化讀取本地資料 (體驗版)
            useEffect(() => {
                const saved = localStorage.getItem('demo_entries');
                if (saved) {
                    setEntries(JSON.parse(saved).map(e => ({...e, createdAt: new Date(e.createdAt)})));
                }
            }, []);

            const saveKey = (key) => {
                localStorage.setItem('gemini_api_key', key);
                setUserApiKey(key);
                setShowKeyModal(false);
            };

            const handleAddEntry = async ({ rawPoints }) => {
                const combinedText = rawPoints.join('\n');
                let aiResult = { summary: "魔法連線中...", characterId: 'mickey' };
                const getRandomChar = () => CHAR_DATA[Math.floor(Math.random() * CHAR_DATA.length)].id;
                
                // 優先使用用戶輸入的 Key
                const currentKey = userApiKey;

                if (currentKey) {
                    try {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${currentKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: `你是一位迪士尼魔法嚮導。請閱讀日記，完成兩個任務：1. summary: 寫一段80字以內的繁體中文短評，語氣溫馨、夢幻。2. characterId: 從列表選出一個最能呼應情緒的角色ID。列表: ${CHAR_DATA.map(c => c.id + ':' + c.keywords).join(', ')} 日記: ${combinedText} 回傳 JSON 格式: { "summary": "...", "characterId": "..." }` }] }],
                                    generationConfig: { responseMimeType: "application/json" }
                                })
                            }
                        );
                        
                        if (!response.ok) throw new Error(`API Error ${response.status}`);
                        const data = await response.json();
                        let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                        const parsed = JSON.parse(rawText.replace(/```json/g, "").replace(/```/g, "").trim());
                        aiResult = { summary: parsed.summary || "魔法收到心意！", characterId: parsed.characterId || getRandomChar() };
                    } catch (e) {
                        console.error("AI Error", e);
                        throw e; 
                    }
                } else {
                    // No Key provided
                    setShowKeyModal(true);
                    throw new Error("請先輸入 API Key");
                }

                const newEntry = {
                    id: Date.now().toString(),
                    text: combinedText,
                    summary: aiResult.summary,
                    plantType: aiResult.characterId,
                    createdAt: new Date(),
                    dateString: new Date().toLocaleDateString('zh-TW')
                };

                const updated = [newEntry, ...entries];
                setEntries(updated);
                localStorage.setItem('demo_entries', JSON.stringify(updated));

                return aiResult; 
            };

            // Calendar Helpers
            const today = new Date();
            const [currentDate, setCurrentDate] = useState(today);
            const calendarData = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const activeDays = new Set();
                entries.forEach(e => {
                    const d = new Date(e.createdAt);
                    if (d.getFullYear() === year && d.getMonth() === month) activeDays.add(d.getDate());
                });
                return { year, month, daysInMonth, firstDay, activeDays };
            }, [currentDate, entries]);

            const changeMonth = (offset) => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1));

            return (
                <div className="min-h-[100dvh] w-full bg-[#FFFBF0] text-[#374151] pb-24 relative flex flex-col">
                    {showKeyModal && <ApiKeyModal onSave={saveKey} />}
                    
                    <header className="px-6 pt-12 pb-2 sticky top-0 z-20 bg-[#FFFBF0]/90 backdrop-blur-md">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="bg-[#F59E0B] p-1.5 rounded-lg text-white"><SvgIcon path={IconPaths.Heart} size={16} fill="white" stroke="none" /></div>
                                <div><h1 className="text-lg font-black text-[#78350F] leading-none">{activeTab === 'collection' ? '迪士尼感恩收藏' : '冒險日誌'}</h1><p className="text-[10px] font-bold text-[#B45309] mt-0.5 tracking-wide">LEVEL {Math.floor(entries.length / 5) + 1} • {entries.length} TOYS</p></div>
                            </div>
                            <button onClick={() => setShowKeyModal(true)} className="bg-white p-2 rounded-full border-2 border-[#F3F4F6] shadow-sm text-[#9CA3AF]"><SvgIcon path={IconPaths.Settings} size={18} /></button>
                        </div>
                    </header>

                    <main className="w-full max-w-lg mx-auto flex-1 px-4">
                        {activeTab === 'collection' ? (
                            <div>
                                <DailyQuote />
                                <div className="mt-6 flex justify-between items-end px-2 mb-4">
                                    <h3 className="text-base font-black text-[#78350F]">我的玩具箱</h3>
                                    <button className="text-xs font-bold text-[#F59E0B] flex items-center gap-1">查看全部 <SvgIcon path={IconPaths.Search} size={12} /></button>
                                </div>
                                {entries.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center py-20 text-center">
                                        <div className="bg-white p-6 rounded-3xl mb-4 shadow-sm border-2 border-[#F3F4F6]"><div className="w-16 h-16 bg-[#FEF3C7] rounded-2xl flex items-center justify-center text-[#F59E0B]"><SvgIcon path={IconPaths.LayoutGrid} size={32} /></div></div>
                                        <h3 className="text-xl font-black text-[#78350F] mb-2">收藏櫃還是空的</h3><p className="text-sm text-[#9CA3AF] font-bold">快去寫第一篇日記<br/>獲得你的第一個夥伴吧！</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-3 gap-3 pb-24">
                                        {entries.map((entry) => {
                                            const itemData = CHAR_DATA.find(i => i.id === entry.plantType) || CHAR_DATA[0];
                                            return (
                                                <button key={entry.id || Math.random()} onClick={() => { setNewRewardItem(entry.plantType); setNewRewardSummary(entry.summary || entry.text); setShowRewardModal(true); }} className="bg-white rounded-2xl p-2 pb-3 shadow-[0_4px_0_#E5E7EB] border-2 border-[#F3F4F6] flex flex-col items-center active:translate-y-1 active:shadow-none transition-all relative overflow-hidden group">
                                                    <div className={`absolute top-0 left-0 w-full h-1 ${itemData.rarity === 'UR' ? 'bg-purple-400' : itemData.rarity === 'SSR' ? 'bg-yellow-400' : 'bg-blue-400'}`}></div>
                                                    <div className="w-full aspect-square relative mb-2 flex items-center justify-center bg-[#FFFBEB] rounded-xl mt-1"><div className="w-[85%] h-[85%] transform group-hover:scale-110 transition-transform duration-300"><UniversalToy config={itemData} /></div></div>
                                                    <div className="text-center w-full"><h4 className="text-[10px] font-black text-[#78350F] truncate w-full px-1">{itemData.name}</h4></div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="pt-6">
                                <div className="bg-white rounded-[32px] p-6 shadow-sm border-2 border-[#F3F4F6] mb-6">
                                    <div className="flex justify-between items-center mb-6"><button onClick={() => changeMonth(-1)} className="p-2 bg-[#F3F4F6] rounded-full text-[#9CA3AF]">&lt;</button><h2 className="text-xl font-black text-[#78350F]">{calendarData.year}年 {calendarData.month + 1}月</h2><button onClick={() => changeMonth(1)} className="p-2 bg-[#F3F4F6] rounded-full text-[#9CA3AF]">&gt;</button></div>
                                    <div className="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-bold text-[#9CA3AF]"><div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div></div>
                                    <div className="grid grid-cols-7 gap-2">{Array.from({length: calendarData.firstDay}).map((_, i) => <div key={`empty-${i}`} />)}{Array.from({length: calendarData.daysInMonth}, (_, i) => i + 1).map(d => {const isActive = calendarData.activeDays.has(d);return (<div key={d} className={`aspect-square rounded-xl flex items-center justify-center text-sm font-black border-2 ${isActive ? 'bg-[#F59E0B] border-[#D97706] text-white shadow-[0_2px_0_#B45309]' : 'bg-white border-[#F3F4F6] text-[#D1D5DB]'}`}>{d}</div>)})}</div>
                                </div>
                                <div className="bg-[#FFF7ED] rounded-[32px] p-6 border-2 border-[#FED7AA] flex items-center gap-4"><div className="w-12 h-12 bg-[#FFEDD5] rounded-full flex items-center justify-center text-[#F97316]"><SvgIcon path={IconPaths.Trophy} size={24} /></div><div><p className="text-xs font-bold text-[#F97316] mb-0.5">本月挑戰</p><p className="text-xl font-black text-[#9A3412]">已達成 {calendarData.activeDays.size} 天</p></div></div>
                            </div>
                        )}
                    </main>

                    <div className="fixed bottom-0 left-0 right-0 z-40 flex justify-center pb-6 pointer-events-none">
                        <div className="bg-white border-2 border-[#F3F4F6] rounded-full p-2 pl-6 pr-6 flex items-center gap-12 shadow-[0_10px_30px_rgba(0,0,0,0.1)] pointer-events-auto">
                           <button onClick={() => setActiveTab('collection')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'collection' ? 'text-[#F59E0B]' : 'text-[#D1D5DB]'}`}><SvgIcon path={IconPaths.LayoutGrid} size={24} /></button>
                           <div className="relative -top-8"><button onClick={() => setIsModalOpen(true)} className="w-16 h-16 bg-[#F59E0B] rounded-[24px] text-white shadow-[0_8px_0_#B45309] flex items-center justify-center transform transition-all active:shadow-none active:translate-y-2 border-4 border-white"><SvgIcon path={IconPaths.Plus} size={32} /></button></div>
                           <button onClick={() => setActiveTab('calendar')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'calendar' ? 'text-[#F59E0B]' : 'text-[#D1D5DB]'}`}><SvgIcon path={IconPaths.Calendar} size={24} /></button>
                        </div>
                    </div>

                    {isModalOpen && <WriteModal onClose={() => setIsModalOpen(false)} onSubmit={handleAddEntry} onSuccess={(res) => {setNewRewardItem(res.characterId); setNewRewardSummary(res.summary); setShowRewardModal(true);}} />}
                    {showRewardModal && <DailyCardModal item={newRewardItem} summary={newRewardSummary} onClose={() => setShowRewardModal(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
